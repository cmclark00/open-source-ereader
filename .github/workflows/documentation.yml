name: Documentation Checks

on:
  push:
    branches: [ master, development ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [ master, development ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CHANGELOG.md'

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run markdownlint
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: .markdownlint.json
          ignore_files: node_modules/
        continue-on-error: true

  link-checker:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check links in README
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          check-modified-files-only: 'no'
          base-branch: 'master'
        continue-on-error: true

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check spelling
        uses: rojopolis/spellcheck-github-actions@0.33.1
        with:
          config_path: .github/spellcheck-config.yml
          task_name: Markdown
        continue-on-error: true

  validate-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check required documentation files
        run: |
          echo "Checking for required documentation files..."

          required_files=(
            "README.md"
            "CHANGELOG.md"
            "docs/BUILD_GUIDE.md"
            "docs/USER_GUIDE.md"
            "docs/CONTRIBUTING.md"
            "docs/DEVELOPMENT.md"
            "docs/hardware/BOM.md"
            "docs/hardware/WIRING_GUIDE.md"
            "docs/hardware/SCHEMATIC.md"
          )

          missing_files=()

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              missing_files+=("$file")
            else
              echo "✅ Found: $file"
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo ""
            echo "Error: Missing required documentation files"
            exit 1
          fi

          echo ""
          echo "All required documentation files are present!"

      - name: Check documentation links structure
        run: |
          echo "Checking for broken wiki-link references..."

          # Find all [[Document-Name]] wiki-links
          grep -roh '\[\[[^]]*\]\]' docs/ README.md CHANGELOG.md 2>/dev/null | sort -u > /tmp/wiki-links.txt || true

          if [ -s /tmp/wiki-links.txt ]; then
            echo "Found wiki-links:"
            cat /tmp/wiki-links.txt
          else
            echo "No wiki-links found (this is okay)"
          fi

      - name: Check for TODO markers in documentation
        run: |
          echo "Checking for TODO markers in documentation..."

          # Search for TODO, FIXME, XXX markers
          if grep -rn "TODO\|FIXME\|XXX" docs/ README.md CHANGELOG.md 2>/dev/null; then
            echo ""
            echo "⚠️  Warning: Found TODO/FIXME markers in documentation"
            echo "This is not a failure, but consider addressing these before release"
          else
            echo "✅ No TODO markers found"
          fi
        continue-on-error: true

      - name: Validate front matter in documentation
        run: |
          echo "Checking YAML front matter in documentation files..."

          # Find markdown files with front matter
          for file in $(find docs -name "*.md" -type f); do
            if head -n 1 "$file" | grep -q "^---$"; then
              echo "✅ $file has front matter"
            fi
          done

          echo "Front matter validation complete"
        continue-on-error: true

  check-code-examples:
    name: Validate Code Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract and validate bash code blocks
        run: |
          echo "Checking bash code blocks in documentation..."

          # Simple check that bash code blocks don't have obvious syntax errors
          # This is a basic check - doesn't actually execute code

          for file in $(find docs README.md -name "*.md" -type f); do
            echo "Checking: $file"

            # Count code blocks
            bash_blocks=$(grep -c '```bash' "$file" || true)
            shell_blocks=$(grep -c '```shell' "$file" || true)

            if [ $bash_blocks -gt 0 ] || [ $shell_blocks -gt 0 ]; then
              echo "  Found $bash_blocks bash blocks and $shell_blocks shell blocks"
            fi
          done

          echo "Code block validation complete"

  summary:
    name: Documentation Check Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, check-code-examples]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "Documentation validation complete!"
          echo ""
          echo "Review the individual job results above for details."
          echo ""
          echo "Note: Some checks are set to continue-on-error and won't fail the build."
          echo "Review warnings and consider addressing them before release."
