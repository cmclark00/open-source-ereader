#!/bin/sh
# WiFi setup helper for E-Reader OS
# Usage: setup-wifi <SSID> <PASSWORD>

if [ $# -lt 2 ]; then
    echo "Usage: setup-wifi <SSID> <PASSWORD>"
    echo "Example: setup-wifi MyNetwork MyPassword123"
    exit 1
fi

SSID="$1"
PASSWORD="$2"

echo "Configuring WiFi for SSID: $SSID"

# Generate wpa_supplicant configuration
cat > /etc/wpa_supplicant.conf << EOF
ctrl_interface=/var/run/wpa_supplicant
update_config=1
country=US

network={
    ssid="$SSID"
    psk="$PASSWORD"
    key_mgmt=WPA-PSK
}
EOF

echo "WiFi configuration saved to /etc/wpa_supplicant.conf"

# Load WiFi kernel modules if not already loaded
if ! lsmod | grep -q brcmfmac; then
    echo "Loading WiFi driver..."
    modprobe brcmfmac
fi

# Bring up wlan0 interface
echo "Bringing up wlan0 interface..."
ip link set wlan0 up

# Start wpa_supplicant
echo "Starting wpa_supplicant..."
killall wpa_supplicant 2>/dev/null
wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant.conf

# Wait a moment for connection
sleep 3

# Get IP address via DHCP
echo "Requesting IP address..."
killall dhcpcd 2>/dev/null
dhcpcd wlan0

sleep 2

# Check connection status
if ip addr show wlan0 | grep -q "inet "; then
    IP=$(ip addr show wlan0 | grep "inet " | awk '{print $2}')
    echo "WiFi connected successfully!"
    echo "IP address: $IP"
else
    echo "Failed to get IP address. Check your SSID and password."
    exit 1
fi
