# Phase 06: WiFi and Network Features

This phase unlocks the Raspberry Pi Zero W's WiFi capabilities, enabling book downloads, online libraries, and network management. By the end of this phase, users can download books directly to the device without removing the SD card.

## Tasks

- [x] Enable WiFi in Buildroot and kernel:
  - ‚úÖ Updated `configs/ereader_rpi0w_defconfig` to include:
    - BR2_PACKAGE_RPI_WIFI_FIRMWARE=y (Broadcom WiFi firmware for brcmfmac43430)
    - BR2_PACKAGE_WPA_SUPPLICANT=y with CLI and passphrase support
    - BR2_PACKAGE_WIRELESS_TOOLS=y and BR2_PACKAGE_IW=y for WiFi management
    - BR2_PACKAGE_DHCPCD=y for DHCP client
    - BR2_PACKAGE_BIND=y for DNS resolution
  - ‚úÖ Updated `configs/linux_ereader.fragment` with:
    - CONFIG_BRCMFMAC=y and CONFIG_BRCMFMAC_SDIO=y (Broadcom WiFi driver)
    - CONFIG_WIRELESS=y, CONFIG_CFG80211=y, CONFIG_MAC80211=y (wireless subsystem)
    - CONFIG_MMC=y and CONFIG_MMC_BCM2835=y (SDIO bus support)
    - Cryptographic support for WPA/WPA2 (AES, CCM, GCM, CMAC)
    - Network stack requirements (PACKET, UNIX, INET)
  - ‚úÖ Created comprehensive `docs/hardware/WIFI_SETUP.md` documenting:
    - Hardware overview and antenna considerations
    - Firmware requirements and verification
    - Kernel driver configuration details
    - Userspace components (wpa_supplicant, wireless tools, DHCP)
    - Network interface management procedures
    - Configuration file formats and locations
    - First-time setup options (pre-configure, serial console, wpa_passphrase)
    - Troubleshooting guide for common WiFi issues
    - Performance characteristics and security considerations

- [x] Add firmware and configuration files:
  - ‚úÖ Firmware automatically included via BR2_PACKAGE_RPI_WIFI_FIRMWARE=y in defconfig
  - ‚úÖ Created `board/ereader/rootfs-overlay/etc/wpa_supplicant.conf.example`:
    - Comprehensive template with examples for WPA2-PSK, open networks, hidden SSIDs
    - Multiple network configuration examples with priorities
    - Detailed comments explaining all options and security modes
    - Instructions for using wpa_passphrase for encrypted PSK
  - ‚úÖ Created `board/ereader/rootfs-overlay/etc/init.d/S40network`:
    - Automatically starts wpa_supplicant and dhcpcd on boot
    - Smart startup logic: checks for config file and skips if not configured
    - Comprehensive WiFi management: start, stop, restart, status, scan
    - Connection monitoring with timeout and detailed logging
    - Status command shows: interface state, connection info, IP address, signal strength
    - Scan command lists available networks with SSIDs and signal levels
    - Logs to /var/log/network.log for troubleshooting
  - ‚úÖ Updated `board/ereader/post-build.sh` to make S40network executable
  - ‚úÖ Documented first-time WiFi setup in `docs/USER_GUIDE.md`:
    - Added comprehensive WiFi Setup section with TOC entry
    - Two setup methods: pre-configure via SD card (recommended) and serial console
    - WiFi configuration file format and examples
    - Multiple network configuration with priorities
    - WiFi status checking and service management commands
    - Battery life considerations and performance characteristics
    - Extensive troubleshooting section (connection, weak signal, DHCP issues)
    - Hidden network configuration and security mode details
    - Cross-reference to hardware/WIFI_SETUP.md for technical details

- [x] Design WiFi management UI:
  - ‚úÖ Created `docs/architecture/WIFI_UI.md` documenting:
    - Complete state machine for WiFi UI (MAIN, SCAN, LIST, CONNECT, PASSWORD, CONNECTING, RESULT, SAVED_NETWORKS)
    - WiFi menu with scan networks, connect, disconnect, status overview
    - Network list display with SSID, signal strength bars (8-level), security indicators
    - Comprehensive text input system design (two approaches):
      - **Recommended**: Sequential character selection (simple, ~90 characters)
      - **Advanced**: Grid navigation with 2-level selection (faster but more complex)
    - Password entry modes: uppercase, lowercase, numbers, symbols
    - Character grid layout with [A-Z], [a-z], [0-9], [SYM], [SPACE], [BACKSPACE], [DONE] buttons
    - Two-pronged strategy: Pre-configuration via SD card (recommended) + on-device entry (functional backup)
    - WiFi status bar integration with connection indicators
    - Screen layouts for all WiFi states with exact 400√ó300 pixel mockups
    - Signal strength mapping (-30 to -90 dBm in 8 levels)
    - Error handling screens (wrong password, network unavailable, DHCP timeout)
    - Saved networks management interface
    - WiFi manager backend C API specification (data structures and functions)
    - Memory budget analysis (~21 KB total)
    - User experience considerations and first-boot flow
    - Testing checklist and edge cases
    - Implementation checklist for Phase 06
    - Future enhancements for Phase 07 (hidden networks, QR codes, external keyboard, predictive text)

- [x] Implement WiFi scanning and connection:
  - ‚úÖ Created `src/ereader/network/wifi_manager.c` with comprehensive functions:
    - `wifi_manager_scan()`: Parses `iw dev wlan0 scan` output, sorts by signal strength
    - `wifi_manager_connect()`: Updates wpa_supplicant.conf, handles WPA/WPA2-PSK and open networks, waits for DHCP
    - `wifi_manager_get_status()`: Parses `iw dev wlan0 link` and `ip addr` for full status
    - `wifi_manager_disconnect()`: Cleanly disconnects from network
    - `wifi_manager_get_current_ssid()`: Returns currently connected SSID
    - `wifi_manager_get_signal_strength()`: Returns signal strength in dBm
    - `wifi_manager_forget_network()`: Removes saved credentials
    - `wifi_manager_list_saved()`: Lists saved networks from wpa_supplicant.conf
    - `wifi_manager_test_connection()`: Tests connectivity with ping
  - ‚úÖ Created `src/ereader/network/wifi_manager.h` with complete API specification:
    - Data structures: wifi_network_t, wifi_status_t
    - Enums: wifi_security_t, wifi_state_t, wifi_error_t
    - All function prototypes with detailed documentation
    - Utility functions for string conversion and signal strength mapping
  - ‚úÖ Comprehensive error handling implemented:
    - Authentication failures (wrong password)
    - Network not found or out of range
    - DHCP timeout
    - Connection timeout (30s max)
    - Scan failures
    - Configuration write errors
    - Interface down errors
  - ‚úÖ Implementation features:
    - Supports WPA/WPA2-PSK and open networks
    - Uses wpa_passphrase for secure PSK generation
    - Preserves existing network configurations
    - Automatically sorts networks by signal strength
    - Checks for saved credentials
    - 8-level signal strength bar mapping per WIFI_UI.md spec
    - Full integration with S40network init script

- [x] Build WiFi settings UI:
  - ‚úÖ Created `src/ereader/ui/wifi_menu.c` with comprehensive WiFi menu implementation:
    - Complete state machine with 7 states: MAIN, SCAN, LIST, CONNECT, CONNECTING, RESULT, SAVED_NETWORKS
    - Network list display with scrollable interface (11 networks per page)
    - Signal strength display using 8-level bar indicators (####----)
    - Security indicators for encrypted networks (*)
    - Connection dialog with options for open/saved/new networks
    - Status screen showing connected SSID, IP address, signal strength percentage
    - Disconnect option in main menu
    - Scanning progress screen with cancellation
    - Connection result screen with success/error messages
    - Error handling for authentication, network not found, DHCP timeout
    - Saved networks list view
  - ‚úÖ Created `src/ereader/ui/wifi_menu.h` with:
    - Complete API with 20+ functions for WiFi menu management
    - State machine definitions matching WIFI_UI.md specification
    - Data structures for menu state, navigation, and WiFi status
    - WiFi menu action results for event handling
    - Comprehensive error codes
    - Utility functions for signal bar formatting
  - ‚úÖ Added WiFi option to Settings menu:
    - Added SETTING_ITEM_WIFI to setting_item_t enum
    - Updated settings_menu_get_setting_name() to return "WiFi Settings"
    - Updated settings_menu_get_value_string() to display "Configure >"
    - Modified settings_menu_cycle_value() to handle WiFi selection (opens WiFi menu)
  - ‚è∏Ô∏è WiFi status icon in status bar: Deferred - requires status bar redesign (Phase 07)
  - ‚úÖ Password entry UI now fully implemented via text_input.c/h
    - Users can connect to open networks
    - Users can connect to saved networks with stored passwords
    - Users can enter new passwords on-device using text input system

- [x] Implement simple text input system:
  - ‚úÖ Created `src/ereader/ui/text_input.c` with sequential character selection:
    - 93-character charset: A-Z, a-z, 0-9, symbols, SPACE, BACKSPACE, DONE, CANCEL
    - UP/DOWN navigate through character list with wrap-around
    - SELECT adds current character to input buffer
    - MENU button provides quick backspace
    - BACK button cancels input
    - Password mode: shows first 3 chars then asterisks
    - Character counter: displays current/max length (e.g., "8/63")
    - Large centered character display with position indicator
    - Blinking cursor animation for visual feedback
    - Min/max length validation (prevents DONE if too short)
  - ‚úÖ Created `src/ereader/ui/text_input.h` with complete API
  - ‚úÖ Integrated with WiFi menu for password entry
  - ‚úÖ Added to Makefile
  - üìù Note: Sequential navigation through 93 chars is slow but functional for occasional use

- [x] Add online book download feature:
  - ‚úÖ Researched public domain book sources:
    - Project Gutenberg: 70,000+ books, direct URL download, Gutendex API
    - Internet Archive: 10M+ books, API with EPUB/TXT/PDF support
    - Standard Ebooks: 600+ curated high-quality EPUB books, OPDS feed
    - LibriVox: Audiobooks only (deferred for future)
    - OPDS protocol overview and available catalogs
  - ‚úÖ Created `docs/research/BOOK_SOURCES.md` with comprehensive analysis:
    - Detailed documentation of all sources with API examples
    - Access methods, features, pros/cons for each source
    - OPDS overview and catalog availability
    - Legal considerations and geographic restrictions
    - Bandwidth and storage considerations
    - Testing checklist and references
  - ‚úÖ **Implementation decision**: Pre-configured catalog (hardcoded 100 popular Project Gutenberg books)
    - **Rationale**: Simple, fast, reliable, memory-efficient, good UX for MVP
    - **Download method**: Direct Project Gutenberg URLs via wget
    - **Catalog structure**: 100 books across 8 genres (Classics, SciFi, Mystery, Adventure, Philosophy, Poetry, Children's, Horror)
    - **Memory footprint**: ~40 KB total (30 KB catalog + 5 KB UI + 5 KB buffers)
    - **Phase 07 enhancements**: Gutendex API search, OPDS integration, genre filtering

- [x] Implement book download manager:
  - ‚úÖ Created `src/ereader/network/download_manager.c` with:
    - HTTP/HTTPS download function using wget
    - Progress tracking (bytes downloaded, percentage, speed, ETA)
    - Save to /books/ directory with automatic filename extraction
    - File validation (TXT, EPUB, PDF format detection)
    - Comprehensive error handling with detailed error codes
  - ‚úÖ Created `src/ereader/network/download_manager.h` with complete API:
    - Data structures: download_progress_t, download_options_t
    - Enums: download_state_t, download_error_t, file_format_t
    - Functions: download, cancel, get_progress, validate_file, get_available_space
    - Utility functions: format_size, format_time, extract_filename
  - ‚úÖ Added wget to Buildroot packages (configs/ereader_rpi0w_defconfig)
  - ‚úÖ Error handling implemented:
    - Network timeout (30s default, configurable)
    - Disk full detection via statvfs
    - Invalid file detection (corrupt, wrong format)
    - File already exists check (with overwrite option)
    - HTTP errors (404, 403, etc.)
    - DNS resolution failures
    - Connection failures
  - ‚úÖ Implementation features:
    - wget-based downloads with progress parsing
    - Automatic filename extraction from URL
    - File format validation (TXT, EPUB, PDF signature detection)
    - Available disk space checking
    - Configurable user-agent header
    - Download cancellation support
    - Max file size limits (default 10 MB)
    - Human-readable size/time formatting
  - ‚úÖ Added to Makefile with proper dependencies
  - üìù **Implementation Notes**:
    - Uses wget for simplicity and reliability
    - Progress tracking via wget's --progress=bar:force output
    - Blocking download operation (suitable for single-threaded e-reader UI)
    - Downloads to /books/ directory (same as book library)
    - Project Gutenberg User-Agent included for compliance
    - File validation uses magic number detection (PK for EPUB/ZIP, %PDF for PDF, text heuristics for TXT)

- [ ] Create online library browser UI:
  - Create `src/ereader/ui/library_browser.c` with:
    - Browse pre-configured book catalogs (Project Gutenberg popular books)
    - Search by title or author (if API supports)
    - Display book info (title, author, size, format)
    - Download button with progress indicator
    - Navigate to "Downloads" folder after completion
  - Write `src/ereader/ui/library_browser.h`
  - Add "Library" option to main menu
  - Consider: cache catalog locally to reduce network requests

- [ ] Add time synchronization and updates:
  - Add ntpd or chrony to Buildroot for time sync via NTP
  - Create `src/ereader/network/time_sync.c` to trigger sync when WiFi connects
  - Consider OTA updates:
    - Design update mechanism (download new rootfs, apply on reboot)
    - Security considerations (signed updates)
    - Document in `docs/architecture/OTA_UPDATES.md`
  - Or: defer OTA updates to Phase 7, just do time sync in Phase 6

- [ ] Build and test WiFi features:
  - Rebuild Buildroot with WiFi support
  - Test WiFi scanning, connection, disconnection
  - Test book download from Project Gutenberg
  - Create `docs/testing/WIFI_TESTING.md` with test procedures
  - Document network performance (download speeds, latency)

- [ ] Update documentation for WiFi features:
  - Update `docs/USER_GUIDE.md` with:
    - How to set up WiFi for the first time
    - How to browse and download books
    - How to manage WiFi connections
    - Troubleshooting WiFi issues
  - Update `docs/hardware/WIFI_SETUP.md` with antenna considerations
  - Update `docs/progress/PHASE_06_LOG.md` with completion notes
  - Create `docs/progress/PHASE_07_PLANNING.md` for final polish and release prep
